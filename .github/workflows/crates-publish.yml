# Publish to crates.io on tag
name: Publish to crates.io

on:
  push:
    tags:
      - 'v*'
      - '[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Publish l3d_rs (core library) first - other crates depend on it
  publish-lib:
    name: Publish l3d_rs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Verify build
        run: cargo build --release -p l3d_rs

      - name: Run tests
        run: cargo test -p l3d_rs

      - name: Publish l3d_rs to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cargo publish -p l3d_rs --allow-dirty 2>&1 | tee publish.log || {
            if grep -q "already uploaded" publish.log; then
              echo "Already published, continuing..."
            else
              cat publish.log
              exit 1
            fi
          }

  # Publish l3d-ffi (UniFFI bindings) after l3d_rs
  publish-ffi:
    name: Publish l3d-ffi
    runs-on: ubuntu-latest
    needs: publish-lib
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Wait for crates.io index update
        run: sleep 60

      - name: Verify build (local workspace)
        run: cargo build --release -p l3d-ffi

      - name: Publish l3d-ffi to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cargo publish -p l3d-ffi --allow-dirty --no-verify 2>&1 | tee publish.log || {
            if grep -q "already uploaded" publish.log; then
              echo "Already published, continuing..."
            else
              cat publish.log
              exit 1
            fi
          }

  # Publish l3d-egui (desktop/WASM viewer) after l3d_rs
  publish-egui:
    name: Publish l3d-egui
    runs-on: ubuntu-latest
    needs: publish-lib
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev libxkbcommon-dev libssl-dev

      - name: Wait for crates.io index update
        run: sleep 60

      - name: Verify build (local workspace)
        run: cargo build --release -p l3d-egui

      - name: Publish l3d-egui to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          cargo publish -p l3d-egui --allow-dirty --no-verify 2>&1 | tee publish.log || {
            if grep -q "already uploaded" publish.log; then
              echo "Already published, continuing..."
            else
              cat publish.log
              exit 1
            fi
          }
