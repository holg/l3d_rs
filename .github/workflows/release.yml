# Build and release binaries for all platforms
name: Release Binaries

on:
  push:
    tags:
      - 'v*'
      - '[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build l3d-viewer binaries (native desktop app)
  build-viewer:
    name: Build l3d-viewer (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: l3d-viewer
            asset_name: l3d-viewer-linux-x86_64
          - os: macos-15
            target: x86_64-apple-darwin
            artifact_name: l3d-viewer
            asset_name: l3d-viewer-macos-x86_64
          - os: macos-14
            target: aarch64-apple-darwin
            artifact_name: l3d-viewer
            asset_name: l3d-viewer-macos-aarch64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: l3d-viewer.exe
            asset_name: l3d-viewer-windows-x86_64.exe

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev libxkbcommon-dev libssl-dev

      - name: Build l3d-viewer
        run: cargo build --release -p l3d-egui --bin l3d-viewer --target ${{ matrix.target }}

      - name: Prepare artifacts (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p artifacts
          cp target/${{ matrix.target }}/release/l3d-viewer artifacts/${{ matrix.asset_name }}
          chmod +x artifacts/*

      - name: Prepare artifacts (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir -p artifacts
          cp target/${{ matrix.target }}/release/l3d-viewer.exe artifacts/${{ matrix.asset_name }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: l3d-viewer-${{ matrix.target }}
          path: artifacts/

  # Build l3d-egui WASM (WebAssembly)
  build-wasm:
    name: Build l3d-egui WASM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Install trunk
        run: cargo install trunk

      - name: Build WASM
        working-directory: crates/l3d-egui
        run: trunk build --release

      - name: Package WASM dist
        run: |
          mkdir -p artifacts
          cp -r crates/l3d-egui/dist artifacts/l3d-viewer-wasm
          cd artifacts && zip -r l3d-viewer-wasm.zip l3d-viewer-wasm/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: l3d-viewer-wasm
          path: artifacts/l3d-viewer-wasm.zip

  # Create GitHub Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-viewer, build-wasm]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -laR artifacts/

      - name: Organize release assets
        run: |
          mkdir -p release-assets

          # l3d-viewer native binaries
          for dir in artifacts/l3d-viewer-x86_64-unknown-linux-gnu artifacts/l3d-viewer-x86_64-apple-darwin artifacts/l3d-viewer-aarch64-apple-darwin artifacts/l3d-viewer-x86_64-pc-windows-msvc; do
            if [ -d "$dir" ]; then
              cp "$dir"/* release-assets/ 2>/dev/null || true
            fi
          done

          # l3d-viewer WASM
          if [ -d "artifacts/l3d-viewer-wasm" ]; then
            cp artifacts/l3d-viewer-wasm/*.zip release-assets/ 2>/dev/null || true
          fi

          ls -la release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## Downloads

            ### l3d-viewer (Native Desktop App)
            | Platform | Download |
            |----------|----------|
            | Linux x86_64 | `l3d-viewer-linux-x86_64` |
            | macOS x86_64 | `l3d-viewer-macos-x86_64` |
            | macOS ARM64 | `l3d-viewer-macos-aarch64` |
            | Windows x86_64 | `l3d-viewer-windows-x86_64.exe` |

            ### l3d-viewer (WebAssembly)
            | Platform | Download |
            |----------|----------|
            | WASM | `l3d-viewer-wasm.zip` |

            ### Python Package
            Install from PyPI: `pip install l3d-rs-python`

            ### Rust Crate
            Add to Cargo.toml: `l3d_rs = "0.2"`
